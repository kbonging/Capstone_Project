<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webcore.platform.mypage.dao.MyCampaignDAO">

  <!-- ==================== 내 체험단 전체 개수 조회 ==================== -->
  <select id="selectMyCampaignCount"
    parameterType="com.webcore.platform.mypage.dto.MyCampaignDTO"
    resultType="int">
    SELECT COUNT(*)
    FROM tb_campaign_application a                -- 신청 테이블
           JOIN tb_campaign c ON c.CAMPAIGN_IDX = a.CAMPAIGN_IDX
    WHERE a.DEL_YN = 'N'                          -- 삭제되지 않은 신청만
      AND a.MEMBER_IDX = #{memberIdx}             -- 현재 회원의 신청만
  </select>

  <!-- ==================== 내 체험단 목록 조회 ==================== -->
  <select id="selectMyCampaignList"
    parameterType="com.webcore.platform.mypage.dto.MyCampaignDTO"
    resultType="com.webcore.platform.mypage.dto.MyCampaignDTO">
    SELECT
      -- 신청 정보
      a.APPLICATION_IDX   AS applicationIdx,      -- 신청 고유번호
      a.APPLY_STATUS_CODE AS applyStatusCode,     -- 신청 상태 코드 (예: CAMAPP_PENDING)
      s.CODE_NM           AS applyStatusName,     -- 신청 상태명 (예: 대기/당첨/탈락)
      a.REG_DATE          AS regDate,             -- 신청일시

      -- 캠페인 기본 정보
      c.CAMPAIGN_IDX      AS campaignIdx,         -- 캠페인 고유번호
      c.TITLE             AS title,               -- 캠페인 제목
      c.SHOP_NAME         AS shopName,            -- 상호명
      c.THUMBNAIL_URL     AS thumbnailUrl,        -- 썸네일 이미지 URL

      c.CAMPAIGN_TYPE     AS campaignType,        -- 캠페인 유형 코드
      prom.CODE_NM        AS campaignTypeName,    -- 캠페인 유형명 (ex. 방문형/배송형)
      c.CAM_CATE_CODE     AS categoryCode,        -- 카테고리 코드
      cate.CODE_NM        AS categoryName,        -- 카테고리명
      c.CHANNEL_CODE      AS channelCode,         -- 채널 코드
      ch.CODE_NM          AS channelName,         -- 채널명 (ex. 인스타그램/블로그)

      -- 혜택 및 일정
      c.BENEFIT_DETAIL    AS benefitText,         -- 제공 혜택 설명
      c.RECRUIT_COUNT     AS recruitCount,        -- 모집 인원
      c.APPLY_END_DATE    AS applyEndDate,        -- 신청 마감일

      -- 신청자 수 (해당 캠페인 전체 기준)
      (SELECT COUNT(1)
       FROM tb_campaign_application aa
       WHERE aa.CAMPAIGN_IDX = c.CAMPAIGN_IDX
         AND aa.DEL_YN = 'N') AS appliedCount,

      -- 마감일까지 남은 일수 (양수=남음, 0=오늘마감, 음수=마감지남)
      DATEDIFF(c.APPLY_END_DATE, CURDATE()) AS remainDays,

      -- 추가 컬럼 (포인트 등 확장용)
      NULL AS rewardPoint,

      -- 공통 관리 컬럼
      a.MOD_DATE AS modDate,                      -- 마지막 수정일
      a.DEL_YN   AS delYn                         -- 삭제 여부
    FROM tb_campaign_application a
           JOIN tb_campaign c ON c.CAMPAIGN_IDX = a.CAMPAIGN_IDX
           LEFT JOIN tb_common_code prom ON prom.CODE_ID = c.CAMPAIGN_TYPE
           LEFT JOIN tb_common_code cate ON cate.CODE_ID = c.CAM_CATE_CODE
           LEFT JOIN tb_common_code ch   ON ch.CODE_ID   = c.CHANNEL_CODE
           LEFT JOIN tb_common_code s    ON s.CODE_ID    = a.APPLY_STATUS_CODE
    WHERE a.MEMBER_IDX = #{memberIdx}             -- 현재 로그인한 회원의 신청만
      AND a.DEL_YN = 'N'                          -- 삭제되지 않은 신청만
    ORDER BY a.REG_DATE DESC                      -- 최신 신청순
      LIMIT #{recordCount} OFFSET #{firstIndex}   -- 페이징 처리
  </select>

  <!-- ==================== 내 체험단 신청 취소 ==================== -->
  <update id="cancelMyApplication">
    UPDATE tb_campaign_application
    SET DEL_YN = 'Y',                             -- 삭제 플래그 처리
        MOD_DATE = NOW()                          -- 수정일 갱신
    WHERE APPLICATION_IDX = #{applicationIdx}     -- 해당 신청 고유번호
      AND MEMBER_IDX = #{memberIdx}               -- 로그인한 회원 본인만
      AND DEL_YN = 'N'                            -- 아직 삭제되지 않은 신청만
      AND APPLY_STATUS_CODE = 'CAMAPP_PENDING'    -- 상태가 '대기'일 때만 취소 가능
  </update>

</mapper>
